<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Reservar Sala - Checkin Room</title>
  <link rel="stylesheet" href="/CSS/components/layout.css">
  <link rel="stylesheet" href="/CSS/reservar/styles.css">
</head>
<body>
  <div class="layout-container">
    <!-- Sidebar -->
    <nav class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <h1 class="sidebar-logo">Checkin Room</h1>
      </div>
      <div class="sidebar-nav">
        <ul>
          <li>
            <a href="/home" class="nav-link">
              <span class="nav-icon">üè†</span>
              <span class="nav-text">Home</span>
            </a>
          </li>
          <li>
            <a href="/reservar" class="nav-link active">
              <span class="nav-icon">üìÖ</span>
              <span class="nav-text">Reservas</span>
            </a>
          </li>
          <li>
            <a href="/reservas/<%= req.session.usuario.id %>/minhas" class="nav-link">
              <span class="nav-icon">üìã</span>
              <span class="nav-text">Minhas Reservas</span>
            </a>
          </li>
          <% if (req.session.usuario.tipo === 'admin') { %>
          <li>
            <a href="/admin" class="nav-link">
              <span class="nav-icon">‚öôÔ∏è</span>
              <span class="nav-text">Painel Admin</span>
            </a>
          </li>
          <% } %>
        </ul>
      </div>
    </nav>

    <!-- Topbar -->
    <header class="topbar" id="topbar">
      <div class="topbar-left">
        <button class="sidebar-toggle" id="sidebarToggle">
          <span>‚ò∞</span>
        </button>
        <h1 class="page-title">Reservar Sala</h1>
      </div>
      <div class="topbar-right">
        <a href="/" class="btn-logout">
          <span>üö™</span>
          <span>Sair</span>
        </a>
      </div>
    </header>

    <!-- Conte√∫do Principal -->
    <main class="main-content" id="mainContent">
      <div class="reservar-container">
        <!-- Header da P√°gina -->
        <div class="page-header">
          <h1>Reservar Sala</h1>
          <p>Selecione uma sala e defina o hor√°rio para sua reserva</p>
        </div>

        <!-- Mensagens de Feedback -->
        <% if (mensagemErro) { %>
          <div class="message erro"><%= mensagemErro %></div>
        <% } %>

        <!-- Se√ß√£o da Tabela -->
        <section class="table-section">
          <div class="table-header">
            <h2 class="table-title">Salas Dispon√≠veis</h2>
          </div>

          <% if (salas && salas.length > 0) { %>
            <table class="salas-table" id="salasTable">
              <thead>
                <tr>
                  <th>Sala</th>
                  <th>Andar</th>
                  <th>Capacidade</th>
                  <th>Data</th>
                  <th>Hor√°rio In√≠cio</th>
                  <th>Hor√°rio Fim</th>
                  <th>A√ß√£o</th>
                </tr>
              </thead>
              <tbody>
                <% salas.forEach((sala, index) => { %>
                  <tr>
                    <form action="/reservar/confirmar" method="POST" class="reserva-form" data-form-index="<%= index %>">
                      <td>
                        <div class="sala-info">
                          <span class="sala-nome"><%= sala.nome %></span>
                          <span class="sala-detalhes"><%= sala.localizacao %></span>
                        </div>
                      </td>
                      <td><%= sala.localizacao %></td>
                      <td><%= sala.capacidade %> pessoas</td>
                      <td>
                        <input type="hidden" name="id_sala" value="<%= sala.id_sala %>">
                        <input
                          type="date"
                          name="data_reserva"
                          class="form-input date-input"
                          data-form-index="<%= index %>"
                          required
                        >
                        <div class="validation-alert" id="dateAlert<%= index %>">
                          N√£o √© poss√≠vel reservar aos finais de semana
                        </div>
                      </td>
                      <td>
                        <input
                          type="time"
                          name="horario_inicio"
                          class="form-input time-input"
                          data-form-index="<%= index %>"
                          step="3600"
                          required
                        >
                        <div class="validation-alert" id="timeStartAlert<%= index %>">
                          Hor√°rio deve ser entre 06:00 e 21:00
                        </div>
                      </td>
                      <td>
                        <input
                          type="time"
                          name="horario_fim"
                          class="form-input time-input"
                          data-form-index="<%= index %>"
                          step="3600"
                          required
                        >
                        <div class="validation-alert" id="timeEndAlert<%= index %>">
                          Hor√°rio deve ser entre 06:00 e 21:00
                        </div>
                      </td>
                      <td>
                        <button type="submit" class="btn-agendar" data-form-index="<%= index %>">
                          Agendar
                        </button>
                      </td>
                    </form>
                  </tr>
                <% }) %>
              </tbody>
            </table>
          <% } else { %>
            <div class="empty-state">
              <div class="icon">üè¢</div>
              <h3>Nenhuma sala dispon√≠vel</h3>
              <p>No momento n√£o h√° salas dispon√≠veis para reserva.</p>
            </div>
          <% } %>
        </section>
      </div>
    </main>
  </div>

  <script>
    // ===== FUNCIONALIDADE DA SIDEBAR =====
    const sidebar = document.getElementById('sidebar');
    const topbar = document.getElementById('topbar');
    const mainContent = document.getElementById('mainContent');
    const sidebarToggle = document.getElementById('sidebarToggle');

    sidebarToggle.addEventListener('click', () => {
      sidebar.classList.toggle('collapsed');
      topbar.classList.toggle('sidebar-collapsed');
      mainContent.classList.toggle('sidebar-collapsed');
    });

    // ===== VALIDA√á√ïES DE DATA E HOR√ÅRIO =====

    // Fun√ß√£o para validar se √© final de semana
    function isWeekend(date) {
      const day = date.getDay();
      return day === 0 || day === 6; // 0 = Domingo, 6 = S√°bado
    }

    // Fun√ß√£o para validar hor√°rio (06:00 √†s 21:00)
    function isValidTime(time) {
      const [hours, minutes] = time.split(':').map(Number);
      const timeInMinutes = hours * 60 + minutes;
      const startTime = 6 * 60; // 06:00
      const endTime = 21 * 60;  // 21:00

      return timeInMinutes >= startTime && timeInMinutes <= endTime;
    }

    // Fun√ß√£o para mostrar/ocultar alertas de valida√ß√£o
    function showValidationAlert(alertId, show = true) {
      const alert = document.getElementById(alertId);
      if (alert) {
        alert.classList.toggle('show', show);
      }
    }

    // Fun√ß√£o para validar formul√°rio
    function validateForm(formIndex) {
      let isValid = true;

      // Validar data
      const dateInput = document.querySelector(`input[name="data_reserva"][data-form-index="${formIndex}"]`);
      if (dateInput && dateInput.value) {
        const selectedDate = new Date(dateInput.value + 'T00:00:00');
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        if (selectedDate < today) {
          showValidationAlert(`dateAlert${formIndex}`, true);
          dateInput.style.borderColor = 'var(--secondary-color)';
          isValid = false;
        } else if (isWeekend(selectedDate)) {
          showValidationAlert(`dateAlert${formIndex}`, true);
          dateInput.style.borderColor = 'var(--secondary-color)';
          isValid = false;
        } else {
          showValidationAlert(`dateAlert${formIndex}`, false);
          dateInput.style.borderColor = 'var(--success-color)';
        }
      }

      // Validar hor√°rio de in√≠cio
      const startTimeInput = document.querySelector(`input[name="horario_inicio"][data-form-index="${formIndex}"]`);
      if (startTimeInput && startTimeInput.value) {
        if (!isValidTime(startTimeInput.value)) {
          showValidationAlert(`timeStartAlert${formIndex}`, true);
          startTimeInput.style.borderColor = 'var(--secondary-color)';
          isValid = false;
        } else {
          showValidationAlert(`timeStartAlert${formIndex}`, false);
          startTimeInput.style.borderColor = 'var(--success-color)';
        }
      }

      // Validar hor√°rio de fim
      const endTimeInput = document.querySelector(`input[name="horario_fim"][data-form-index="${formIndex}"]`);
      if (endTimeInput && endTimeInput.value) {
        if (!isValidTime(endTimeInput.value)) {
          showValidationAlert(`timeEndAlert${formIndex}`, true);
          endTimeInput.style.borderColor = 'var(--secondary-color)';
          isValid = false;
        } else {
          showValidationAlert(`timeEndAlert${formIndex}`, false);
          endTimeInput.style.borderColor = 'var(--success-color)';
        }
      }

      // Validar se hor√°rio de fim √© posterior ao de in√≠cio
      if (startTimeInput && endTimeInput && startTimeInput.value && endTimeInput.value) {
        const startTime = startTimeInput.value;
        const endTime = endTimeInput.value;

        if (endTime <= startTime) {
          showValidationAlert(`timeEndAlert${formIndex}`, true);
          endTimeInput.style.borderColor = 'var(--secondary-color)';
          document.getElementById(`timeEndAlert${formIndex}`).textContent = 'Hor√°rio de fim deve ser posterior ao de in√≠cio';
          isValid = false;
        }
      }

      // Atualizar estado do bot√£o
      const submitButton = document.querySelector(`button[data-form-index="${formIndex}"]`);
      if (submitButton) {
        submitButton.disabled = !isValid;
      }

      return isValid;
    }

    // ===== EVENT LISTENERS =====

    // Configurar data m√≠nima (hoje)
    const today = new Date().toISOString().split('T')[0];
    document.querySelectorAll('.date-input').forEach(input => {
      input.min = today;

      input.addEventListener('change', (e) => {
        const formIndex = e.target.dataset.formIndex;
        validateForm(formIndex);
      });
    });

    // Configurar valida√ß√£o de hor√°rios
    document.querySelectorAll('.time-input').forEach(input => {
      input.addEventListener('change', (e) => {
        const formIndex = e.target.dataset.formIndex;
        validateForm(formIndex);
      });
    });

    // Validar formul√°rios antes do envio
    document.querySelectorAll('.reserva-form').forEach(form => {
      form.addEventListener('submit', (e) => {
        const formIndex = form.dataset.formIndex;
        if (!validateForm(formIndex)) {
          e.preventDefault();
          alert('Por favor, corrija os erros no formul√°rio antes de continuar.');
        }
      });
    });

    // ===== INICIALIZA√á√ÉO =====
    document.addEventListener('DOMContentLoaded', () => {
      console.log('P√°gina de reservas carregada com sucesso!');

      // Validar todos os formul√°rios inicialmente
      document.querySelectorAll('.reserva-form').forEach(form => {
        const formIndex = form.dataset.formIndex;
        validateForm(formIndex);
      });
    });
  </script>
</body>
</html>
